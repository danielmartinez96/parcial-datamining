---
title: "Analisis exploratorio de dataSet 'House-Pricing'"

fig:height: 4
output:
  html_notebook:
    df_print: paged
    fig:height: 4
    fig:width: 6
    theme: readable
    toc: yes
    toc_float: yes
    
author: "Alvarez Ignacio Nicolas-Martinez Daniel Martinez"
---

# Carga de Librerias
```{r Librerías}
library("dplyr")
library("corrplot")
library("fastDummies")
library("ggplot2")
library("rpart")
library("rpart.plot")
library("caret")
library("caTools")
library("randomForest")
library("class")
library("lubridate")
library("e1071")
library("psych")
library("car")
library("mctest") # libreria para calculo de TOF Y VIF
```

# Establecimiento del entorno de trabajo
```{r}
#setwd("~/R-WORKSPACE/Parcial2/parcial-datamining/")
```

# Cargar del DataSet
```{r Carga del DataSet}
a_raw_data <- read.csv("house_data.csv")
```

 
# DataSet
```{r}
a_raw_data
```

# Estructura del DataSet
```{r Estructura del DataSet}
str(a_raw_data)
```

# Descripcion del DataSet
```{r Descripcion del DataSet}
summary(a_raw_data)
```

# Analisis Exploratorio   

## Boxplot Price, Bedrooms y Bathrooms   
* El atributo Price presenta outliers para valores superiores a 1e^6, donde existen valores extremos superiores a 6e^6.   
* El atributo bathrooms posee una mediana alrrededor de 4, donde existen valores extremos de 0 y valores superiores a 6.   
* El atributo bedrooms posee una mediana alrrededor de 3, un un valor extremo superiore a 30.   

```{r Boxplot price-bedrooms-bathroom}
par(mfrow = c(1,3))
boxplot(a_raw_data$price, main="Price")
boxplot(a_raw_data$bedrooms, main="Cant Bedrooms")
boxplot(a_raw_data$bathrooms, main="Cant Bathrooms")
```

## Boxplot Sqft_living y Sqft_living15   

* El atributo sqft_living presenta una mediana de 2000, y valores atipicos superiores a 3000, se destacan valores extremos superiores a 10000.   
* El atributo sqft_living15 presenta una mediana alrrededor de 2000, y valores atipicos para valores alrrededor a 4000, los valores outliers se encuentran mas cercanos entre sí que en sqft_living.   

```{r Boxplot sqft_living-sqft_living15}
par(mfrow = c(1,2))
boxplot(a_raw_data$sqft_living, main="sqft_living (ft^2)")
boxplot(a_raw_data$sqft_living15, main="sqft_living15 (ft^2)")
```

## Boxplot Sqft_lot y Sqft_lot15   

* El atributo sqft_lot presenta una mediana alrrededor de cero y outliers para todos los valores superiores, destacando valores extremos superiores a 1000000. Ocurre lo mismo con el atributo sqft_lot15.   

```{r Boxplot sqft_lot-sqft_lot15}
par(mfrow = c(1,2))
boxplot(a_raw_data$sqft_lot, main="sqft_lot (ft^2)")
boxplot(a_raw_data$sqft_lot15, main="sqft_lot15 (ft^2)")
```

## Boxplot Sqft_above y Sqft_basement     

* El atributo sqft_above posee una mediana alrrededor de 2000, y outliers para valores superiores a 4000.   
* El atributo sqft_basement posee una mediana alrrededor de 0 y valores outliers para valores superiores a 1500.    

```{r Boxplot sqft_above-sqft_basement}
par(mfrow = c(1,2))
boxplot(a_raw_data$sqft_above, main="sqft_above (ft^2)")
boxplot(a_raw_data$sqft_basement, main="sqft_basement (ft^2)")
```

## Barplot Waterfront y View   

* Mediante el barplot del atributo Waterfront se observa que la amplia mayoria de instancias no posee waterfront.    
* Mediante el barplot del atributo view se observa que la mayoria de instancias no fueron visitadas previamente.    

```{r Barplot waterfront, View}
par(mfrow = c(1,2))
barplot(table(as.factor(a_raw_data$waterfront)), main="waterfront", col="blue")
barplot(table(as.factor(a_raw_data$view)), main="view",col="blue")
```

## Histograma zipcode, yr_renovated y yr_built


* Mediante el histograma del atributo yr_renovated se observa que la mayoria de instancias no fueron renovadas.

```{r Histograma zipcode, yr_renovated, yr_built}
par(mfrow = c(1,3))
hist(a_raw_data$zipcode, col="blue" ,breaks= 60, freq= F)
hist(a_raw_data$yr_renovated, col="blue" ,breaks= 60, freq= F)
hist(a_raw_data$yr_built, col="blue" ,breaks= 60, freq= F)
```


# Estudio de la variable target: Price    
## Histograma    

* Mediante el histograma de la variable objetivo Price se observa que tiene una distribucion similar a la distribucion normal, con un marcado sesgo hacia la derecha.

```{r Histograma Price Raw}
hist(a_raw_data$price, col="blue", breaks = 60, freq = F)
lines(density(a_raw_data$price), col = "red", lwd=2)
rug(a_raw_data$price)
```

## Graficos de Dispersion: Price vs Todos    

* Date      vs Price: Debido al formato del atributo Price, el grafico no aporta mucha información.   
* Bedrooms  vs Price: Aparentemente, la cantidad de bedrooms no tiene relacion directa con el precio.   
* Bathrooms vs Price: Aparentemente, existe una relacion donde a mayor cantidad de bathrooms mayor es el precio, sin embargo no se repleja en todas las instancias.    
* Sqft_living vs Price: Aparentemente, existe una relacion donde a mayor sqft_living mayor es el precio, sin embargo el incremento parece poco significativo en el intervalo (0,4000) de sqft_living.    
* FALTAN LAS DEMAS     
 
```{r Graficos de Dispersion: Price vs Todos}
plot(price~., data=a_raw_data,col="blue")
```

## Estudio de correlacion   

```{r Estudio de correlacion}
corrplot(cor(select(a_raw_data,-c("id","date"))),type="upper", method="pie")
cor(select(a_raw_data,-c("id","date")))
```

* Mediante el diagrama de correlacion sobre el raw_data, existe una fuerte relación entre la variable objetivo price y las variables sqft_living, grade, sqft_above y sqft_living15.   

```{r Correlacion sobre DataRaw}
imcdiag(select(a_raw_data, -c("price","date", "id")), a_raw_data$price)
```

* Se observa que el valor de VIF en relacion con los atributos sqft_living, sqft_above y sqft_basement, es muy elevado, lo cual puede implicar colinealidad.     

# Regresion lineal con raw data 

```{r Regresion lineal con dataSet sin limpiar}
lm_sin_limpiar <- lm(data = a_raw_data,formula = price ~ . -id -date)
summary(lm_sin_limpiar)
```

* Segun el t - value: las variables más relevantes son: bedrooms, bathrooms, grade, sqft_living, waterfront, lat y yr_built.    
Si bien el R^2 es de 0.70, este modelo esta sujeto posiblemente bajo colinealidad, por lo tanto necesita retrabajo y una seleccion de variables.   

## Residuos: modelo sobre raw data

```{r Plot de residuos modelo Raw}
par(mfrow=c(2,2))
plot(lm_sin_limpiar)
```

* Residuals vs Fitted: la recta se adecua al cero, sin embargo existen valores que se encuentran dispersos, muy separados de la recta.    
* Normal Q-Q: Como los graficos no se adecuan a la recta diagonal, se supone que las instancias no se encuentran normalmente distribuidas.    
* Scale-Location: La recta no se adecua al cero, es influenciada por una alta concentracion de puntos. Instancias como la 391, que se encuentra en el extremo superior derecho del grafico, influye sobre la grafica.   
* Residuals vs Leverage: Se puede obervar que existen valores muy cercanos a 0.5, por lo tanto son instancias particulares que tienen influencia significativa sobre el modelo.   

```{r Plot de residuos 1°: Histograma de Modelo raw}
residuos = resid(lm_sin_limpiar)
hist(residuos, col = "blue", freq = F)
lines(density(residuos), col = "red", lwd=2)
rug(residuos)
```


# Analisis de variables

## IDs Duplicados

```{r Registros de precio id duplicado}
raw_duplicadosID = a_raw_data[duplicated(a_raw_data$id), ]
dim(raw_duplicadosID)
```

Existen 177 registros con ID repetidos, pero distintos precio y date. Aparentemente son instancias que fueron vendidas nuevamente en el plazo considerado 2014-2015.   

```{r }
a_raw_data = a_raw_data %>% group_by(id) %>% filter(price==max(price))
```

Consideramos las instancias con precio mayor en ese plazo como precio actualizado.    

## CONDITION & GRADE

```{r Barplot GRADE VS CONDITION}
par(mfrow = c(1,2))
barplot(table(as.factor(a_raw_data$condition)), main="condition")
barplot(table(as.factor(a_raw_data$grade)), main="grade")
```

```{r Corrplot price, grade, condition}
corrplot(cor(select(a_raw_data, c("price", "grade", "condition"))),method="square")
cor(select(a_raw_data, c("price", "grade", "condition")))
```
Mediante este grafico de correlacion se puede observar que existe una fuerte relacion entre PRICE y GRADE, mientras que la relacion con Condition es debil.    

* Aparentemente Grade y Condition refieren la misma caracteristica de una instancia.    

```{r Correlacion sobre df sin condicion}
imcdiag(select(a_raw_data, -c("date", "id", "condition")), select(a_raw_data, -c("date", "id", "condition"))$price)
```

Mediante la eliminacion del atributo Condition se redujo el valor de VIF del atributo GRADE.     

### Regresion lineal con df sin condicion     

```{r Regresion lineal con df sin condicion}
lm_sin_condicion <- lm(formula = price ~ ., data = select(a_raw_data, -c("date", "id", "condition")))
summary(lm_sin_condicion)
```

```{r Plot de residuos modelo sin condicion}
par(mfrow=c(2,2))
plot(lm_sin_condicion)
```

```{r Plot de residuos 1°: Histograma de modelo sin condicion}

residuos = resid(lm_sin_condicion)
hist(residuos, col = "blue", freq = F)
lines(density(residuos), col = "red", lwd=2)
rug(residuos)
```

## Year_renovated

```{r Corplot price, yr_renovated y yr_built}
corrplot(cor(a_raw_data[,c("price","yr_renovated","yr_built")]),method="square")
```

Aparentemente la variable price tiene poca relacion con los atributos yr_renovated y yr_built.    

```{r Dimension de yr_renovated distintas a cero}
dim(filter(a_raw_data,yr_renovated>0))
```
Existen 911 instancias renovadas.    

```{r Dimension de yr_renovated >= a yr_built}
dim(filter(a_raw_data,yr_renovated>=yr_built))
```

Existen 911 instancias renovadas. Esto implica que las instacias renovadas no son incoherentes, dado que deben tener una fecha de renovacion superior a la fecha de construccion.      

```{r Boxplot yr_renovated y yr_built}
par(mfrow = c(1,3))
boxplot(filter(a_raw_data,yr_renovated>=yr_built)$yr_renovated, main="Renovated")$stats
boxplot(filter(a_raw_data,yr_renovated>0)$yr_built, main="Built")$stats
```

```{r Filtro yr_renovated > 1957}
filter(filter(a_raw_data,yr_renovated>=yr_built), yr_renovated>1957)
```

```{r}
par(mfrow = c(1,3))
boxplot(filter(filter(a_raw_data,yr_renovated>=yr_built), yr_renovated>1957)$yr_renovated, main="Renovated Desdepues del filtro")$stats
summary(filter(filter(a_raw_data,yr_renovated>=yr_built), yr_renovated>1957)$yr_renovated)
plot(filter(filter(a_raw_data,yr_renovated>=yr_built), yr_renovated>1957)$price ~ filter(filter(a_raw_data,yr_renovated>=yr_built), yr_renovated>1957)$yr_renovated)
```

### DATE

La fecha presenta un formato que es necesario cambiar, se busca ver la relacion entre los distintos año/meses y el precio de las casas

```{r}
df_fecha_form = a_raw_data %>% select(price,date)  %>% mutate(date_year = paste(year(date), month(date), sep="/"))
```

```{r}
pie(table(df_fecha_form$date_year))
```

Salvo casos particulares parece que la fecha de publicacion supongo, no afecta el precio de una casa.
```{r Plot Fecha por año/mes vs Price}
plot(df_fecha_form$price ~ as.factor(df_fecha_form$date_year))
```


```{r}
df_antiguedad= a_raw_data
df_antiguedad$date =  as.Date(df_antiguedad$date, format = "%Y%m%dT000000")
df_antiguedad= mutate(df_antiguedad,antiguedad= ifelse(yr_renovated>0, 
                                                      year(date)-yr_renovated,
                                                      year(date)-yr_built))
```

```{r}
par(mfrow = c(1,2))
boxplot(df_antiguedad$antiguedad)
summary(df_antiguedad$antiguedad)
plot(price~antiguedad,data=df_antiguedad)
```

## Regresion lineal con Atributo Antiguedad

```{r Regresion lineal con antiguedad}
modelo_fecha<-lm(price ~ . -yr_renovated -yr_built -date -id, data=df_antiguedad)
summary(modelo_fecha)
```


```{r Analisis de las dimensiones}

prueba1 = a_raw_data
corrplot(cor(prueba1[,c("sqft_living","sqft_lot","sqft_above","sqft_living15","sqft_lot15","sqft_basement")]),method="square")

#prueba = mutate(prueba,sqft_living.nuevo=a_raw_data$sqft_above/a_raw_data$sqft_living)

modelo_dim1 <-lm(price~sqft_living+sqft_lot+sqft_above+sqft_living15+sqft_lot15+sqft_basement, data=prueba1)
summary(modelo_dim1)

#vif(modelo_dim1) Aca no uso esto por que me da error por que dice que hay collinealdiad perfecta que es la de basement y la de above con living

pair1= select(a_raw_data,sqft_living,sqft_lot,sqft_above,sqft_basement)
pairs(pair1)



prueba1 = mutate(prueba1,sqft_lot15.nuevo=(a_raw_data$sqft_lot-a_raw_data$sqft_lot15)/a_raw_data$sqft_lot)

prueba1 = mutate(prueba1,sqft_living15.nuevo=(a_raw_data$sqft_living-a_raw_data$sqft_living15)/a_raw_data$sqft_living)

corrplot(cor(prueba1[,c("sqft_living","sqft_lot","sqft_living15.nuevo","sqft_lot15.nuevo")]),method="square")

modelo_dim2 <-lm(price~sqft_living+sqft_lot+sqft_living15.nuevo+sqft_lot15.nuevo, data=prueba1)
summary(modelo_dim2)


vif(modelo_dim2)
#Aca podemos ver que no existe colinealidad con los valores y ademas mejora un poco el R2
```

```{r COLINEALDAD PRUEBA}
imcdiag(select(prueba1, -c("price","date")), prueba1$price)
```


```{r Outliers Price}

price_con_outliers= filter(a_raw_data,price>1010000)
price_sin_outliers= filter(a_raw_data,!price>1010000)



par(mfrow = c(1,2))
boxplot(price_con_outliers$price, main="con outliers")
boxplot(price_sin_outliers$price, main="sin outliers")
hist(price_sin_outliers$price, breaks = 100)
summary(price_sin_outliers$price)


```

```{r Precio / metro cuadrado }

precio_lot=mutate(a_raw_data,sqft_price=price/sqft_lot15)
summary(precio_lot$sqft_price)
hist(precio_lot$sqft_price)
boxplot(precio_lot$sqft_price)
plot(sqft_price~price,data=precio_lot)


precio_lot2=filter(precio_lot,sqft_price>13)
precio_lot2=filter(precio_lot2,sqft_price<550)
precio_lot2=filter(precio_lot2,price<1010000)
summary(precio_lot2$sqft_price)
hist(precio_lot2$sqft_price)
boxplot(precio_lot2$sqft_price)
plot(price~bedrooms,data=precio_lot2)
boxplot(precio_lot2$price)
hist(precio_lot2$price, breaks = 100)
```
```{r Correlacion}
#correlation<-round(cor(var1[,4:22]),2)
#corAvg<-colMeans (correlation[ , 1:19])
#corAvg<-data.frame(corAvg)
#correlation
#corAvg[order(corAvg$corAvg,decreasing = TRUE),]

imcdiag(select(data_set, -c("Price")), data_set$Price)

```



```{r Bathrooms y bedrooms}


data_bb=filter(a_raw_data,bedrooms<15)
data_bb=mutate(data_bb,bedbat=ifelse(bedrooms>0,bathrooms/bedrooms,bathrooms))
plot(price~bedbat,data=data_bb)
hist(data_bb$bedbat,breaks=30)
data_bb=filter(data_bb,bedbat>0)
data_bb=filter(data_bb,bedbat<=2)
hist(data_bb$bedbat,breaks=30)
boxplot(data_bb$bedbat)
plot(price~bedbat,data=data_bb)
summary(lm(price~bedbat,data=data_bb))
summary(lm(price~bedrooms,data=data_bb))
summary(lm(price~bathrooms,data=data_bb))


```


```{r Zipcode relacion con lat y long }
dim15=a_raw_data
#zipcodepro$zipcode=as.factor(zipcodepro$zipcode)
dim15= mutate(dim15,livingdif=sqft_living-sqft_living15)

summary(dim15$livingdif)
hist(dim15$livingdif)
```

```{r view y waterfront }

plot(price~view,data=a_raw_data)
summary(lm(price~view,data=a_raw_data))

plot(price~waterfront,data=a_raw_data)
summary(lm(price~waterfront,data=a_raw_data))

summary(lm(price~waterfront+view,data=a_raw_data))


```

#Llegue a la conclucion, de que para zipcode en necesario ponerlo como factor y me afecta
```{r zip code y lat long }

modelo_zipcode= lm(price~zipcode,data=a_raw_data)
summary(modelo_zipcode)

modelo_latlong= lm(price~as.numeric(long)+as.numeric(lat),data=a_raw_data)
summary(modelo_latlong)

plot(price~as.numeric(long)+as.numeric(lat),data=a_raw_data)

par(mfrow = c(1,2))
boxplot(as.numeric(a_raw_data$lat), main="lat")
boxplot(as.numeric(a_raw_data$long), main="long")

hist(as.numeric(a_raw_data$lat))
hist(as.numeric(a_raw_data$long))
data_latlong=a_raw_data
data_latlong$long=as.numeric(data_latlong$long)
data_latlong$lat=as.numeric(data_latlong$lat)
data_latlong=filter(data_latlong,long<(-121.78))
data_latlong=filter(data_latlong,lat>(47.2))
boxplot(data_latlong$lat, main="lat")
boxplot(data_latlong$long, main="long")
modelo_latlong= lm(price~long+lat,data=data_latlong)
plot(price~long+lat,data=data_latlong)
summary(modelo_latlong)
```
### Limpieza de datos
```{r Limpieza de datos}

clean_data=a_raw_data

#Long Lat
clean_data$long=as.numeric(clean_data$long)
clean_data$lat=as.numeric(clean_data$lat)

clean_data=filter(clean_data,long<(-121.6))
clean_data=filter(clean_data,lat>(47.2))

#Precio/Sqft
clean_data=filter(clean_data,(price/sqft_lot15)>13)
clean_data=filter(clean_data,(price/sqft_lot15)<550)

clean_data=filter(clean_data,(bedrooms/bathrooms)<=3)

# Fecha a antiguedad
clean_data$date =  as.Date(clean_data$date, format = "%Y%m%dT000000")
clean_data= mutate(clean_data,antiguedad=ifelse(yr_renovated>0,yr_renovated-yr_built,year(date)-yr_built))

clean_data$zipcode=as.numeric(clean_data$zipcode)
clean_data$waterfront=as.numeric(clean_data$waterfront)
var1= clean_data

clean_data= select(clean_data,-yr_built,-yr_renovated,-date,-zipcode)
clean_data= select(a_raw_data,-id,-condition,-sqft_basement,-sqft_above)
#Dimensiones
#clean_data = mutate(clean_data,sqft_lot15.nuevo=(a_raw_data$sqft_lot-a_raw_data$sqft_lot15)/a_raw_data$sqft_lot)

#Dimensiones
#clean_data = mutate(clean_data,sqft_living15.nuevo=(a_raw_data$sqft_living-a_raw_data$sqft_living15)/a_raw_data$sqft_living)





clean_data= select(clean_data,-sqft_living,-sqft_lot,-view,-waterfront)

modelo_clean<-lm(price~.,data=clean_data)
summary(modelo_clean)
vif(modelo_clean)

#outliers
clean_data= filter(clean_data,price<1010000)

modelo_clean<-lm(price~.,data=clean_data)
summary(modelo_clean)
vif(modelo_clean)

####
plot(modelo_clean)
hist(modelo_clean$residuals,breaks=40)

```
```{r}
splitdata<- createDataPartition(y=modelo_clean$price, p=0.70,list=FALSE)
train_data<-modelo_clean[splitdata,]
test_data<-modelo_clean[-splitdata,]

lmfist<- train(price~.,data=train_data,method="lm")
model_test<-data.frame(ubs=test_data$price,pred=predicted_test)
model_train<-data.frame(obs=test_data$price,pred=predited_test)
defaultSummary(model_test)

```
```{r}
imcdiag(select(clean_data, -c("price","date")), clean_data$price)

```


